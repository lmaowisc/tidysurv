---
title: "Tidy Survival Analysis: Applying Râ€™s Tidyverse to Survival Data"
subtitle: "Module 3. Nonparametric Survival Analysis"
css: style.css
# csl: apa.csl
author:
  name: Lu Mao
  affiliations: 
    - name: Department of Biostatistics & Medical Informatics
    - University of Wisconsin-Madison
    - Aug 2, 2025
  email: lmao@biostat.wisc.edu
format: 
  revealjs:
    theme: simple
    # auto-stretch: false
    # incremental: true
    toc: true
    toc-depth: 1
    # small: true
editor: visual
execute: 
  eval: false
  echo: true
  # cache: true
include-in-header:
  - text: |
      <style type="text/css">
      ul li ul li {
        font-size: 0.78em;
      }
      </style>
# bibliography: references.bib
# title-slide-attributes: 
#   data-background-image: jsm_logo.png
#   data-background-size: 20%
#   data-background-position: 2% 2%
---


# Tabulating Survival Estimates

## GBC: Relapse-Free Survival

- Use `dplyr` to get time-to-first event

```{r}
#| eval: true
library(tidyverse) # Load tidyverse packages
# Load mortality + relapse data
gbc <- read.table("data/gbc.txt", header = TRUE)
df <- gbc |>  # calculate time to first event (relapse or death)
  group_by(id) |> # group by id
  arrange(time) |> # sort rows by time
  slice(1) |>      # get the first row within each id
  ungroup()     # remove grouping
# Display the first few rows of the data
head(df) 
```

## Raw Output from `survfit()`

- **KM estimates by hormone therapy**

```{r}
#| eval: true
library(survival) # Load survival package
# Fit KM estimates by hormone group
km_fit <- survfit(Surv(time, status > 0) ~ hormone, data = df)
# summarize the KM fit object
summary(km_fit, times = c(6, 12, 24, 36))
```

## Extracting Survival Estimates

- **Elements in `survfit` object**
    - `time`: time points of the survival estimates
    - `surv`: survival probabilities at the time points
    - `lower, upper`: confidence intervals for the survival estimates
    - `strata`: stratification information (if applicable)

::: {.callout-note appearance="minimal"}
## Exercise
Create a table of survival estimates with 95\% confidence intervals at 6, 12, 24, and 36 months for each hormone therapy group using `dplyr` and `tibble`.
:::

## Tidying `survfit()` Output

- **Use `broom` package to tidy `survfit` objects**
    - `broom::tidy()` converts the `survfit` object into a tidy data frame
    - Useful for further analysis or visualization

```{r}
#| eval: true
library(broom) # Load broom package
tidy(km_fit) # Tidy the KM fit object
```



## Tabulation with `gtsummary` 

- **Main function: `tbl_survfit()`**
    - Takes on `survfit` object
    - Creates a table of survival estimates with confidence intervals
    - Automatically handles stratification and time points
```{r}
#| eval: true
library(gtsummary) # Load gtsummary package
# Create a table of survival estimates
km_fit |> tbl_survfit(                    # Pass `survfit` object
             label = "Hormone",           # Row label: "Hormone"
             times = c(6, 12, 24, 36),     # Time points for estimates
             label_header = "Month {time}" # Column label: "Month xx"
             ) 
```

## Grouping by Multiple Variables

- **Pass raw data to `tbl_survfit()`**

```{r}
#| eval: true
df |>                                       # Use raw data
  tbl_survfit(y = Surv(time, status),       # Survival object
              include = c(meno, grade),     # Include variables: menopause, grade
              label = list(meno = "Menopause", # Row labels
                          grade = "Tumor grade"),
              times = c(6, 12, 24, 36),     # Time points for estimates
              label_header = "Month {time}" # Column label: "Month xx"
             ) 
```



## Tabulating Quantile Estimates

- **Quantile estimates**: Median survival time, quartiles, etc.
    - Specify `probs` argument in `tbl_survfit()`

```{r}
#| eval: true
# Create a table of quantile estimates
km_fit |>                        # Pass `survfit` object
  tbl_survfit(
    label = "Hormone",           # Row label: "Hormone"
    probs = c(0.25, 0.5, 0.75),  # Quantiles: 25%, 50%, 75%
              label_header = "{100 * prob}% quantile") # Column label: "xx quantile"
```



## Exercise: Tabulating Quantiles

- **Create the following table**

```{r}
#| eval: true
#| echo: false
df |>                                       # Use raw data
  tbl_survfit(y = Surv(time, status),       # Survival object
              include = c(meno, grade),     # Include variables: menopause, grade
              label = list(meno = "Menopause", # Row labels
                          grade = "Tumor grade"),
              probs = c(0.25, 0.5, 0.75),   # Quantiles: 25%, 50%, 75%
              label_header = "{100 * prob}% quantile" # Column label: "xx quantile"
             )

```

```{r}
#| code-fold: true
#| code-summary: Solution
df |>                                       # Use raw data
  tbl_survfit(y = Surv(time, status > 0),   # Survival object
              include = c(meno, grade),     # Include variables: menopause, tumor grade
              label = list(meno = "Menopause", grade = "Tumor grade"), # Row labels
              probs = c(0.25, 0.5, 0.75),   # Quantiles: 25%, 50%, 75%
              label_header = "{100 * prob}% quantile") # Column label: "xx quantile"

```


## Customizing the Table

- **Customize table appearance**
    - `label_header`: change column names
    - `label`: change row labels
    - `statistic`: customize statistics displayed
        - `statistic = "{estimate} ({conf.low}, {conf.high})"` for confidence intervals

-   More about `gtsummary`
    -   [gtsummary](https://www.danieldsjoberg.com/gtsummary/) website
    -   [tbl_survfit documentation](https://www.danieldsjoberg.com/gtsummary/articles/tbl_survfit.html)


# Visualizing Kaplan-Meier Curves

## Base Plot

```{r}
#| code-fold: true
#| code-summary: Plot KM curves by hormone group
#| eval: true
plot(km_fit, ylim = c(0,1), xlab = "Time (months)", ylab = "Relapse-free survival probability",
     col = c("red", "blue"), conf.int = TRUE)
# Add legend
legend(1, 0.2, col=c("red", "blue"), lty = 1, c("No hormone", "Hormone")) # Legend text
# p-value for log-rank test
pval <- survdiff(Surv(time, status) ~ hormone, data = df)$pvalue # obtain p-value
text(70, 0.8, scales::pvalue(pval, add_p = TRUE)) # Annotate formatted p-value
```

## Enhanced Graphics with `ggsurvfit`

- **`ggsurvfit`**: Provides a `ggplot2` interface for survival curves
    - Takes on `survfit` object or raw data
    - Allows for more customization and aesthetics
    - `add_risktable = TRUE` adds a risk table below graph



# Tidy Analysis of Competing Risks

# Summary

## Key Takeaways


