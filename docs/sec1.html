<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lu Mao">

<title>Tidy Survival Analysis: Applying R’s Tidyverse to Survival Data – Tidy Survival Analysis — A Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-960e3fff4a7fad3e47419792f1865cb1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style type="text/css">
ul li ul li {
  font-size: 0.78em;
}
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="style.css">
<meta name="twitter:title" content="Tidy Survival Analysis: Applying R’s Tidyverse to Survival Data – Tidy Survival Analysis — A Workshop">
<meta name="twitter:description" content="Module 1. Introduction">
<meta name="twitter:image" content="https://lmaowisc.github.io/tidysurv/images/rat_swim.png">
<meta name="twitter:image-height" content="395">
<meta name="twitter:image-width" content="999">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Tidy Survival Analysis — A Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Tidy Survival Analysis: Applying R’s Tidyverse to Survival Data</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Module 1. Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Module 2. Data Manipulation with Tidyverse</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./np.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Module 3. Nonparametric Survival Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Module 4. Semiparametric Regression Analysis</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#basics-of-survival-analysis" id="toc-basics-of-survival-analysis" class="nav-link active" data-scroll-target="#basics-of-survival-analysis">Basics of Survival Analysis</a>
  <ul>
  <li><a href="#time-to-event-data" id="toc-time-to-event-data" class="nav-link" data-scroll-target="#time-to-event-data">Time-to-Event Data</a></li>
  <li><a href="#follow-up-swimmer-plot" id="toc-follow-up-swimmer-plot" class="nav-link" data-scroll-target="#follow-up-swimmer-plot">Follow-up (Swimmer) Plot</a></li>
  <li><a href="#basic-estimands" id="toc-basic-estimands" class="nav-link" data-scroll-target="#basic-estimands">Basic Estimands</a></li>
  <li><a href="#observed-censored-data" id="toc-observed-censored-data" class="nav-link" data-scroll-target="#observed-censored-data">Observed (Censored) Data</a></li>
  </ul></li>
  <li><a href="#german-breast-cancer-study-a-working-example" id="toc-german-breast-cancer-study-a-working-example" class="nav-link" data-scroll-target="#german-breast-cancer-study-a-working-example">German Breast Cancer Study: A Working Example</a>
  <ul>
  <li><a href="#german-breast-cancer-gbc-study" id="toc-german-breast-cancer-gbc-study" class="nav-link" data-scroll-target="#german-breast-cancer-gbc-study">German Breast Cancer (GBC) Study</a></li>
  <li><a href="#data-format-i" id="toc-data-format-i" class="nav-link" data-scroll-target="#data-format-i">Data Format (I)</a></li>
  <li><a href="#data-format-ii" id="toc-data-format-ii" class="nav-link" data-scroll-target="#data-format-ii">Data Format (II)</a></li>
  <li><a href="#analysis-goals" id="toc-analysis-goals" class="nav-link" data-scroll-target="#analysis-goals">Analysis Goals</a></li>
  </ul></li>
  <li><a href="#standard-analysis-with-survival-package" id="toc-standard-analysis-with-survival-package" class="nav-link" data-scroll-target="#standard-analysis-with-survival-package">Standard Analysis with <code>survival</code> Package</a>
  <ul>
  <li><a href="#survival-package-overview" id="toc-survival-package-overview" class="nav-link" data-scroll-target="#survival-package-overview">Survival Package Overview</a></li>
  <li><a href="#kaplan-meier-survival-curves" id="toc-kaplan-meier-survival-curves" class="nav-link" data-scroll-target="#kaplan-meier-survival-curves">Kaplan-Meier Survival Curves</a></li>
  <li><a href="#kaplan-meier-curves-i" id="toc-kaplan-meier-curves-i" class="nav-link" data-scroll-target="#kaplan-meier-curves-i">Kaplan-Meier Curves (I)</a></li>
  <li><a href="#kaplan-meier-curves-ii" id="toc-kaplan-meier-curves-ii" class="nav-link" data-scroll-target="#kaplan-meier-curves-ii">Kaplan-Meier Curves (II)</a></li>
  <li><a href="#kaplan-meier-curves-iii" id="toc-kaplan-meier-curves-iii" class="nav-link" data-scroll-target="#kaplan-meier-curves-iii">Kaplan-Meier Curves (III)</a></li>
  <li><a href="#log-rank-test" id="toc-log-rank-test" class="nav-link" data-scroll-target="#log-rank-test">Log-Rank Test</a></li>
  <li><a href="#cox-model---model-specification" id="toc-cox-model---model-specification" class="nav-link" data-scroll-target="#cox-model---model-specification">Cox Model - Model Specification</a></li>
  <li><a href="#cox-model---model-fitting-i" id="toc-cox-model---model-fitting-i" class="nav-link" data-scroll-target="#cox-model---model-fitting-i">Cox Model - Model Fitting (I)</a></li>
  <li><a href="#cox-model---model-fitting-ii" id="toc-cox-model---model-fitting-ii" class="nav-link" data-scroll-target="#cox-model---model-fitting-ii">Cox Model - Model Fitting (II)</a></li>
  <li><a href="#cox-model---prediction-i" id="toc-cox-model---prediction-i" class="nav-link" data-scroll-target="#cox-model---prediction-i">Cox Model - Prediction (I)</a></li>
  <li><a href="#cox-model---prediction-ii" id="toc-cox-model---prediction-ii" class="nav-link" data-scroll-target="#cox-model---prediction-ii">Cox Model - Prediction (II)</a></li>
  <li><a href="#cox-model---prediction-iii" id="toc-cox-model---prediction-iii" class="nav-link" data-scroll-target="#cox-model---prediction-iii">Cox Model - Prediction (III)</a></li>
  <li><a href="#cox-model---check-ph-assumptions-i" id="toc-cox-model---check-ph-assumptions-i" class="nav-link" data-scroll-target="#cox-model---check-ph-assumptions-i">Cox Model - Check PH Assumptions (I)</a></li>
  <li><a href="#cox-model---check-ph-assumptions-ii" id="toc-cox-model---check-ph-assumptions-ii" class="nav-link" data-scroll-target="#cox-model---check-ph-assumptions-ii">Cox Model - Check PH Assumptions (II)</a></li>
  <li><a href="#cox-model---check-covariate-forms" id="toc-cox-model---check-covariate-forms" class="nav-link" data-scroll-target="#cox-model---check-covariate-forms">Cox Model - Check Covariate Forms</a></li>
  <li><a href="#coding-exercise" id="toc-coding-exercise" class="nav-link" data-scroll-target="#coding-exercise">Coding Exercise</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a>
  <ul>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a></li>
  <li><a href="#open-questions" id="toc-open-questions" class="nav-link" data-scroll-target="#open-questions">Open Questions</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="sec1.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tidy Survival Analysis: Applying R’s Tidyverse to Survival Data</h1>
<p class="subtitle lead">Module 1. Introduction</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Lu Mao <a href="mailto:lmao@biostat.wisc.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Department of Biostatistics &amp; Medical Informatics
          </p>
        <p class="affiliation">
            University of Wisconsin-Madison
          </p>
        <p class="affiliation">
            Aug 2, 2025
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="basics-of-survival-analysis" class="level1">
<h1>Basics of Survival Analysis</h1>
<section id="time-to-event-data" class="level2">
<h2 class="anchored" data-anchor-id="time-to-event-data">Time-to-Event Data</h2>
<ul>
<li>A common type of outcome in medical and clinical studies
<ul>
<li><strong>Starting point</strong>: Randomization, diagnosis, enrollment, birth, etc.<br>
</li>
<li><strong>Endpoint (Event of interest)</strong>: Death, disease onset, hospitalization, etc.
<ul>
<li><strong>Engineering</strong>: Failure times of machines or components (reliability)</li>
<li><strong>Social sciences</strong>: Time to job change, dropout, or event occurrence</li>
</ul></li>
</ul></li>
<li><strong>Right censoring</strong>:
<ul>
<li>Event not observed within the follow-up period</li>
<li>Due to study ending, dropout, or loss to follow-up</li>
<li>We only know:<br>
<span class="math display">\[
T &gt; C
\]</span> where <span class="math inline">\(T\)</span> is event time and <span class="math inline">\(C\)</span> is censoring time</li>
</ul></li>
</ul>
</section>
<section id="follow-up-swimmer-plot" class="level2">
<h2 class="anchored" data-anchor-id="follow-up-swimmer-plot">Follow-up (Swimmer) Plot</h2>
<ul>
<li>A rat tumorigenicity study</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/rat_swim.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
</section>
<section id="basic-estimands" class="level2">
<h2 class="anchored" data-anchor-id="basic-estimands">Basic Estimands</h2>
<ul>
<li><strong>Survival function</strong>: <span class="math inline">\(S(t) = \Pr(T &gt; t)\)</span>
<ul>
<li>Probability subject survives beyond time <span class="math inline">\(t\)</span></li>
</ul></li>
<li><strong>Hazard function</strong>:<br>
<span class="math display">\[
\lambda(t) = \lim_{\Delta t \to 0} \frac{\Pr(t \leq T &lt; t + \Delta t \mid T \geq t)}{\Delta t}
\]</span>
<ul>
<li>Instantaneous risk of failure at time <span class="math inline">\(t\)</span></li>
</ul></li>
<li><strong>Relationship</strong> <span class="math display">\[
S(t) = \exp\left(-\int_0^t \lambda(u) \mathrm{d}u\right)
\]</span>
<ul>
<li><strong>Cumulative hazard function</strong>: <span class="math inline">\(\Lambda(t) = \int_0^t \lambda(u) \mathrm{d}u\)</span></li>
</ul></li>
</ul>
</section>
<section id="observed-censored-data" class="level2">
<h2 class="anchored" data-anchor-id="observed-censored-data">Observed (Censored) Data</h2>
<ul>
<li><strong>Notation</strong>: <span class="math inline">\((X, \delta)\)</span>
<ul>
<li><span class="math inline">\(X=\min(T, C)\)</span>: observation time (event or censoring)</li>
<li><span class="math inline">\(\delta = I(T\leq C)\)</span>: event indicator (1 for event, 0 for censoring)</li>
</ul></li>
<li><strong>Data format</strong></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># time = X, status = delta (tidy format)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    id    time status</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>     <span class="dv">1</span>     <span class="dv">5</span>     <span class="dv">1</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>     <span class="dv">2</span>     <span class="dv">3</span>     <span class="dv">0</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>     <span class="dv">3</span>     <span class="dv">8</span>     <span class="dv">1</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>     <span class="dv">4</span>     <span class="dv">2</span>     <span class="dv">0</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span>     <span class="dv">5</span>     <span class="dv">6</span>     <span class="dv">1</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    id    time </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>     <span class="dv">1</span>     <span class="dv">5</span>   </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>     <span class="dv">2</span>     <span class="dv">3</span><span class="sc">+</span>  </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>     <span class="dv">3</span>     <span class="dv">8</span>  </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>     <span class="dv">4</span>     <span class="dv">2</span><span class="sc">+</span>  </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span>     <span class="dv">5</span>     <span class="dv">6</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="german-breast-cancer-study-a-working-example" class="level1">
<h1>German Breast Cancer Study: A Working Example</h1>
<section id="german-breast-cancer-gbc-study" class="level2">
<h2 class="anchored" data-anchor-id="german-breast-cancer-gbc-study">German Breast Cancer (GBC) Study</h2>
<ul>
<li><strong>Study Information</strong>
<ul>
<li><strong>Population</strong>: 686 patients with node-positive breast cancer<br>
</li>
<li><strong>Objective</strong>: Assess if tamoxifen + chemo reduces mortality/relapse<br>
</li>
<li><strong>Baseline info</strong>: Age, tumor size, hormone levels, menopausal status, etc.<br>
</li>
<li><strong>Follow-up</strong>: Median 44 months
<ul>
<li>171 deaths <span class="math inline">\(\to\)</span> exact times known<br>
</li>
<li>515 censored <span class="math inline">\(\to\)</span> survival time <span class="math inline">\(&gt;\)</span> censoring time</li>
</ul></li>
</ul></li>
<li><strong>Data sets</strong>:
<ul>
<li>Mortality data: <a href="https://lmaowisc.github.io/tidysurv/data/gbc_mort.txt" target="_blank">https://lmaowisc.github.io/tidysurv/data/gbc_mort.txt</a></li>
<li>Mortality + relapse: <a href="https://lmaowisc.github.io/tidysurv/data/gbc.txt" target="_blank">https://lmaowisc.github.io/tidysurv/data/gbc.txt</a></li>
<li>Download and save in a <code>data</code> folder under your root directory</li>
</ul></li>
</ul>
</section>
<section id="data-format-i" class="level2">
<h2 class="anchored" data-anchor-id="data-format-i">Data Format (I)</h2>
<ul>
<li><strong>Death only</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load mortality data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>gbc_mort <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"data/gbc_mort.txt"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the first few rows of the data frame</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gbc_mort)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id      time status hormone age meno size grade nodes prog estrg
1  1 74.819672      0       1  38    1   18     3     5  141   105
2  2 65.770492      0       1  52    1   20     1     1   78    14
3  3 47.737705      1       1  47    1   30     2     1  422    89
4  4  4.852459      0       1  40    1   24     1     3   25    11
5  5 61.081967      0       2  64    2   19     2     1   19     9
6  6 63.377049      0       2  49    2   56     1     3  356    64</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The data frame 'gbc_mort' contains:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  time:   time (months) to death or censoring</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  status: event indicator (1 = death, 0 = censoring)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># hormone: Hormone therapy (1 = no, 2 = yes); age: Age at diagnosis (years);</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># meno: Menopausal status (1 = no, 2 = yes); size: Tumor size (mm); grade: Tumor grade (1–3);</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># nodes: Number of positive lymph nodes; prog: Progesterone receptor level (fmol/mg); estrg:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Estrogen receptor level (fmol/mg).</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-format-ii" class="level2">
<h2 class="anchored" data-anchor-id="data-format-ii">Data Format (II)</h2>
<ul>
<li><strong>Mortality + relapse</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load mortality + relapse data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>gbc <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"data/gbc.txt"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the first few rows of the data frame</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gbc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id     time status hormone age meno size grade nodes prog estrg
1  1 43.83607      1       1  38    1   18     3     5  141   105
2  1 74.81967      0       1  38    1   18     3     5  141   105
3  2 46.55738      1       1  52    1   20     1     1   78    14
4  2 65.77049      0       1  52    1   20     1     1   78    14
5  3 41.93443      1       1  47    1   30     2     1  422    89
6  3 47.73770      2       1  47    1   30     2     1  422    89</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The data frame 'gbc' contains:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  time:   time (months) to death, relapse, or censoring</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  status: event indicator (1 = relapse, 2 = death, 0 = censoring)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  other covariates the same as in gbc_mor.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analysis-goals" class="level2">
<h2 class="anchored" data-anchor-id="analysis-goals">Analysis Goals</h2>
<ul>
<li><strong>Descriptive</strong>
<ul>
<li>Summarize patient characteristics</li>
<li>Visualize survival distributions</li>
</ul></li>
<li><strong>Inferential</strong>
<ul>
<li>Compare survival curves (e.g., hormone therapy vs.&nbsp;no hormone therapy)</li>
<li>Assess impact of covariates on survival (e.g., age, tumor size, etc.)</li>
<li>Model competing risks (e.g., relapse vs.&nbsp;death)</li>
</ul></li>
<li><strong>Predictive</strong>
<ul>
<li>Develop risk prediction models</li>
<li>Evaluate model performance (e.g., concordance index, calibration)</li>
</ul></li>
</ul>
</section>
</section>
<section id="standard-analysis-with-survival-package" class="level1">
<h1>Standard Analysis with <code>survival</code> Package</h1>
<section id="survival-package-overview" class="level2">
<h2 class="anchored" data-anchor-id="survival-package-overview">Survival Package Overview</h2>
<ul>
<li><strong>Key Functions</strong>
<ul>
<li><code>Surv()</code>: Create survival object</li>
<li><code>survfit()</code>: Fit Kaplan-Meier survival curves</li>
<li><code>survdiff()</code>: Compare survival curves (log-rank test)</li>
<li><code>coxph()</code>: Fit Cox proportional hazards regression models</li>
<li><code>survreg()</code>: Fit parametric survival regression models</li>
</ul></li>
</ul>
</section>
<section id="kaplan-meier-survival-curves" class="level2">
<h2 class="anchored" data-anchor-id="kaplan-meier-survival-curves">Kaplan-Meier Survival Curves</h2>
<ul>
<li><strong>Create dataset for relapse-free survival</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by subject id, then time</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span> <span class="fu">order</span>(gbc<span class="sc">$</span>id, gbc<span class="sc">$</span>time)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>gbc <span class="ot">&lt;-</span> gbc[o,]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only first row per subject =&gt; first event</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> gbc[<span class="sc">!</span><span class="fu">duplicated</span>(gbc<span class="sc">$</span>id), ]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert status &gt; 0 to 1 if it is either relapse or death</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>status <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df<span class="sc">$</span>status <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id      time status hormone age meno size grade nodes prog estrg
1  1 43.836066      1       1  38    1   18     3     5  141   105
3  2 46.557377      1       1  52    1   20     1     1   78    14
5  3 41.934426      1       1  47    1   30     2     1  422    89
7  4  4.852459      0       1  40    1   24     1     3   25    11
8  5 61.081967      0       2  64    2   19     2     1   19     9
9  6 63.377049      0       2  49    2   56     1     3  356    64</code></pre>
</div>
</div>
</section>
<section id="kaplan-meier-curves-i" class="level2">
<h2 class="anchored" data-anchor-id="kaplan-meier-curves-i">Kaplan-Meier Curves (I)</h2>
<ul>
<li><strong>Fit Kaplan-Meier survival curves</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival) </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit KM curves by hormone treatment group</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>km_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone, <span class="at">data =</span> df)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>km_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(time, status) ~ hormone, data = df)

            n events median 0.95LCL 0.95UCL
hormone=1 440    205   50.1    42.5    59.5
hormone=2 246     94   66.2    62.9      NA</code></pre>
</div>
</div>
</section>
<section id="kaplan-meier-curves-ii" class="level2">
<h2 class="anchored" data-anchor-id="kaplan-meier-curves-ii">Kaplan-Meier Curves (II)</h2>
<ul>
<li><p><strong>Summarize survival estimates at specified time points</strong></p>
<ul>
<li>For example, at 6, 12, 24, and 36 months</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km_fit, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">36</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(time, status) ~ hormone, data = df)

                hormone=1 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    6    419       9    0.979 0.00691        0.966        0.993
   12    379      35    0.897 0.01476        0.868        0.926
   24    280      73    0.720 0.02203        0.678        0.764
   36    195      41    0.606 0.02475        0.559        0.656

                hormone=2 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    6    236       4    0.983 0.00826        0.967        1.000
   12    223       8    0.950 0.01418        0.922        0.978
   24    177      38    0.785 0.02701        0.733        0.839
   36    136      16    0.708 0.03047        0.650        0.770</code></pre>
</div>
</div></li>
</ul>
</section>
<section id="kaplan-meier-curves-iii" class="level2">
<h2 class="anchored" data-anchor-id="kaplan-meier-curves-iii">Kaplan-Meier Curves (III)</h2>
<ul>
<li><strong>Plot Kaplan-Meier survival curves by group</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km_fit, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">xlab =</span> <span class="st">"Time (months)"</span>, <span class="at">ylab =</span> <span class="st">"Relapse-free survival probability"</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add legend</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">1</span>, <span class="fl">0.2</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="dv">1</span>, </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">c</span>(<span class="st">"No hormone"</span>, <span class="st">"Hormone"</span>)) <span class="co"># Legend text</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sec1_files/figure-revealjs/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="log-rank-test" class="level2">
<h2 class="anchored" data-anchor-id="log-rank-test">Log-Rank Test</h2>
<ul>
<li><strong>Compare survival curves between groups</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>lgr_obj <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone, <span class="at">data =</span> df)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>lgr_obj <span class="co"># Print log-rank test results</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(time, status) ~ hormone, data = df)

            N Observed Expected (O-E)^2/E (O-E)^2/V
hormone=1 440      205      180      3.37      8.56
hormone=2 246       94      119      5.12      8.56

 Chisq= 8.6  on 1 degrees of freedom, p= 0.003 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>lgr_obj<span class="sc">$</span>pvalue <span class="co"># Extract p-value</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.003427282</code></pre>
</div>
</div>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<p>Perform a log-rank test on treatment stratified by patient menopausal status <code>meno</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Solution</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone <span class="sc">+</span> <span class="fu">strata</span>(meno), <span class="at">data =</span> df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</section>
<section id="cox-model---model-specification" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---model-specification">Cox Model - Model Specification</h2>
<ul>
<li><strong>Cox proportional hazards model</strong> <span class="math display">\[
\lambda(t \mid Z) = \lambda_0(t) \exp(\beta_1 Z_1 + \beta_2 Z_2 + \ldots + \beta_p Z_p)
\]</span>
<ul>
<li><span class="math inline">\(\lambda_0(t)\)</span>: baseline hazard function</li>
<li><span class="math inline">\(Z=(Z_1,\ldots, Z_p)^\mathrm{T}\)</span>: covariates (e.g., hormone therapy, age, tumor size)</li>
<li><span class="math inline">\(\beta=(\beta_1，\ldots，\beta_p)^\mathrm{T}\)</span>: regression coefficients</li>
<li><span class="math inline">\(\exp(\beta_j)\)</span>: hazard ratio for covariate <span class="math inline">\(Z_j\)</span></li>
</ul></li>
<li><strong>Proportional hazards (PH) assumption</strong> <span class="math display">\[
\frac{\lambda(t \mid Z)}{\lambda(t \mid Z^*)} = \exp\{\beta^\mathrm{T}(Z - Z^*)\}
\]</span>
<ul>
<li>HR constant over time, i.e., <span class="math inline">\(\beta(t) \equiv \beta\)</span> (for each covariate)</li>
</ul></li>
</ul>
</section>
<section id="cox-model---model-fitting-i" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---model-fitting-i">Cox Model - Model Fitting (I)</h2>
<ul>
<li><strong>Model fitting</strong>: <code>survival::coxph()</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>cox_fit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone <span class="sc">+</span> meno <span class="sc">+</span> age <span class="sc">+</span> grade <span class="sc">+</span> size <span class="sc">+</span> prog <span class="sc">+</span> estrg, </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_fit) <span class="co"># Print model summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ hormone + meno + age + grade + 
    size + prog + estrg, data = df)

  n= 686, number of events= 299 

              coef  exp(coef)   se(coef)      z Pr(&gt;|z|)    
hormone -0.3422139  0.7101963  0.1290669 -2.651  0.00801 ** 
meno     0.2765637  1.3185909  0.1837781  1.505  0.13236    
age     -0.0087813  0.9912572  0.0093375 -0.940  0.34700    
grade    0.2785797  1.3212519  0.1051531  2.649  0.00807 ** 
size     0.0152793  1.0153966  0.0036877  4.143 3.42e-05 ***
prog    -0.0023307  0.9976720  0.0005803 -4.016 5.91e-05 ***
estrg    0.0001678  1.0001679  0.0004669  0.359  0.71923    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
hormone    0.7102     1.4081    0.5515    0.9146
meno       1.3186     0.7584    0.9198    1.8904
age        0.9913     1.0088    0.9733    1.0096
grade      1.3213     0.7569    1.0752    1.6236
size       1.0154     0.9848    1.0081    1.0228
prog       0.9977     1.0023    0.9965    0.9988
estrg      1.0002     0.9998    0.9993    1.0011

Concordance= 0.651  (se = 0.016 )
Likelihood ratio test= 68.4  on 7 df,   p=3e-12
Wald test            = 61.93  on 7 df,   p=6e-11
Score (logrank) test = 61.23  on 7 df,   p=9e-11</code></pre>
</div>
</div>
</section>
<section id="cox-model---model-fitting-ii" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---model-fitting-ii">Cox Model - Model Fitting (II)</h2>
<ul>
<li>Extracting <span class="math inline">\(\hat\beta\)</span> and <span class="math inline">\(\hat{\mathrm{var}}(\hat\beta)\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> cox_fit<span class="sc">$</span>coefficients <span class="co"># Estimated coefficients</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>vbeta <span class="ot">&lt;-</span> <span class="fu">vcov</span>(cox_fit) <span class="co"># Estimated variance-covariance matrix</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract regression table (as data frame)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(<span class="fu">summary</span>(cox_fit))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 coef exp(coef)     se(coef)          z     Pr(&gt;|z|)
hormone -0.3422138547 0.7101963 0.1290669350 -2.6514448 8.014821e-03
meno     0.2765636858 1.3185909 0.1837780595  1.5048787 1.323553e-01
age     -0.0087812621 0.9912572 0.0093375120 -0.9404285 3.469978e-01
grade    0.2785796730 1.3212519 0.1051531448  2.6492757 8.066449e-03
size     0.0152793172 1.0153966 0.0036877471  4.1432660 3.423945e-05
prog    -0.0023307288 0.9976720 0.0005803186 -4.0162919 5.912102e-05
estrg    0.0001678465 1.0001679 0.0004669057  0.3594870 7.192308e-01</code></pre>
</div>
</div>
<ul>
<li><strong>Conclusion</strong>
<ul>
<li>Hormone therapy significantly reduces the risk of relapse or death by <span class="math inline">\(1-0.710=29\%\)</span> (<span class="math inline">\(p\)</span> = 0.008)</li>
</ul></li>
</ul>
</section>
<section id="cox-model---prediction-i" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---prediction-i">Cox Model - Prediction (I)</h2>
<ul>
<li><p><strong>Predicted survival function</strong> <span class="math display">\[
\hat S(t \mid z) = \exp\left\{- \exp(\hat\beta^\mathrm{T} z) \hat\Lambda_0(t)\right\}
\]</span></p></li>
<li><p>Prepare new data for prediction</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new data for prediction</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># specify all covariate values</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">hormone =</span> <span class="dv">1</span>, <span class="at">meno =</span> <span class="dv">1</span>, </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">age =</span> <span class="dv">45</span>, <span class="at">grade =</span> <span class="dv">2</span>, </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">size =</span> <span class="dv">20</span>, <span class="at">prog =</span> <span class="dv">100</span>, </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">estrg =</span> <span class="dv">100</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>new_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  hormone meno age grade size prog estrg
1       1    1  45     2   20  100   100</code></pre>
</div>
</div>
</section>
<section id="cox-model---prediction-ii" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---prediction-ii">Cox Model - Prediction (II)</h2>
<ul>
<li><strong>Predict survival probabilities at specified time points</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict survival probabilities at 6, 12, 24, 26 months</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>predicted_survival <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_fit, <span class="at">newdata =</span> new_data[<span class="dv">1</span>, ], <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">36</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(predicted_survival, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">36</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = cox_fit, newdata = new_data[1, ], times = c(6, 
    12, 24, 36))

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    6    655      13    0.985 0.00441        0.976        0.994
   12    602      43    0.933 0.01059        0.913        0.954
   24    457     111    0.786 0.02304        0.743        0.833
   36    331      57    0.696 0.02925        0.641        0.755</code></pre>
</div>
</div>
</section>
<section id="cox-model---prediction-iii" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---prediction-iii">Cox Model - Prediction (III)</h2>
<ul>
<li><strong>Plot predicted survival function</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot predicted survival function</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(predicted_survival, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlab =</span> <span class="st">"Time (months)"</span>, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Relapsep-free survival probability"</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sec1_files/figure-revealjs/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cox-model---check-ph-assumptions-i" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---check-ph-assumptions-i">Cox Model - Check PH Assumptions (I)</h2>
<ul>
<li><strong>Schoenfeld residuals</strong>
<ul>
<li>Difference between observed and expected covariate values at each event time</li>
<li>Use <code>cox.zph()</code> to test PH assumption</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>ph_test <span class="ot">&lt;-</span> <span class="fu">cox.zph</span>(cox_fit)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ph_test <span class="co"># Print test results</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         chisq df      p
hormone  0.272  1 0.6017
meno     5.514  1 0.0189
age      9.430  1 0.0021
grade    8.490  1 0.0036
size     0.872  1 0.3505
prog     4.881  1 0.0272
estrg    5.403  1 0.0201
GLOBAL  20.636  7 0.0043</code></pre>
</div>
</div>
</section>
<section id="cox-model---check-ph-assumptions-ii" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---check-ph-assumptions-ii">Cox Model - Check PH Assumptions (II)</h2>
<ul>
<li><strong>Graphical check of PH assumptions</strong>
<ul>
<li>Plot Schoenfeld residuals against time</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>)) <span class="co"># Set up 2x4 plotting area for 7 covariates</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ph_test, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="co"># Plot Schoenfeld residuals</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sec1_files/figure-revealjs/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cox-model---check-covariate-forms" class="level2">
<h2 class="anchored" data-anchor-id="cox-model---check-covariate-forms">Cox Model - Check Covariate Forms</h2>
<ul>
<li><p><strong>Check linearity of covariate effects</strong></p>
<ul>
<li>Plot martingale residuals against (quantitative) covariates</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract martingale residuals </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>mart_resid <span class="ot">&lt;-</span> <span class="fu">residuals</span>(cox_fit, <span class="at">type =</span> <span class="st">'martingale'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Plotting</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>))  <span class="co"># Set up 1x4 plotting area for 4 covariates</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot martingale residuals against age</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df<span class="sc">$</span>age, mart_resid, <span class="at">xlab =</span> <span class="st">"Age"</span>, <span class="at">ylab =</span> <span class="st">"Martingale Residuals"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Age"</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add smoothed line</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">lowess</span>(df<span class="sc">$</span>age, mart_resid), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="co"># Add horizontal line at 0</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeat for other covariates</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df<span class="sc">$</span>size, mart_resid, <span class="at">xlab =</span> <span class="st">"Tumor Size"</span>, <span class="at">ylab =</span> <span class="st">"Martingale Residuals"</span>,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Tumor Size"</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">lowess</span>(df<span class="sc">$</span>size, mart_resid), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="co"># Add horizontal line at 0</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df<span class="sc">$</span>prog, mart_resid, <span class="at">xlab =</span> <span class="st">"Progesterone Receptor"</span>, <span class="at">ylab =</span> <span class="st">"Martingale Residuals"</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Progesterone Receptor"</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">lowess</span>(df<span class="sc">$</span>prog, mart_resid), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="co"># Add horizontal line at 0</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df<span class="sc">$</span>estrg, mart_resid, <span class="at">xlab =</span> <span class="st">"Estrogen Receptor"</span>, <span class="at">ylab =</span> <span class="st">"Martingale Residuals"</span>,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Estrogen Receptor"</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">lowess</span>(df<span class="sc">$</span>estrg, mart_resid), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="co"># Add horizontal line at 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sec1_files/figure-revealjs/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div></li>
</ul>
</section>
<section id="coding-exercise" class="level2">
<h2 class="anchored" data-anchor-id="coding-exercise">Coding Exercise</h2>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<p>Residual analyses show that the proportional hazards assumption is violated for tumor grade, and that the effect of age is not linear.</p>
<p>Fit a different model to address these issues.</p>
<div class="cell">
<details class="code-fold">
<summary>Sample solution</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dichotomize age at 40</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>age40 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df<span class="sc">$</span>age <span class="sc">&lt;</span> <span class="dv">40</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Cox model stratified by tumor grade and with binary age </span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>cox_fit2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone <span class="sc">+</span> meno <span class="sc">+</span> age40 <span class="sc">+</span> size <span class="sc">+</span> prog <span class="sc">+</span> estrg <span class="sc">+</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">strata</span>(grade), <span class="at">data =</span> df)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_fit2) <span class="co"># Print model summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ul>
<li>Survival analysis is essential for (often censored) time-to-event data</li>
<li>Key estimands: survival function, hazard function, cumulative hazard</li>
<li>Standard analysis tools
<ul>
<li>Kaplan-Meier curves (<code>survfit()</code>)</li>
<li>Log-rank test (<code>survdiff()</code>)</li>
<li>Cox proportional hazards model (<code>coxph()</code>)</li>
</ul></li>
</ul>
</section>
<section id="open-questions" class="level2">
<h2 class="anchored" data-anchor-id="open-questions">Open Questions</h2>
<ul>
<li>Efficient/effective presentation of survival probabilities
<ul>
<li>Point estimates, confidence intervals</li>
</ul></li>
<li>Customizable survival curves
<ul>
<li>Add at risk table below graph</li>
</ul></li>
<li>Presentation of regression results
<ul>
<li>Hazard ratios, confidence intervals, p-values</li>
<li>Visualize regression results (e.g., forest plots)</li>
</ul></li>
</ul>



</section>
</section>

</main> <!-- /main -->


<script>

  // htmlwidgets need to know to resize themselves when slides are shown/hidden.

  // Fire the "slideenter" event (handled by htmlwidgets.js) when the current

  // slide changes (different for each slide format).

  (function () {

    // dispatch for htmlwidgets

    function fireSlideEnter() {

      const event = window.document.createEvent("Event");

      event.initEvent("slideenter", true, true);

      window.document.dispatchEvent(event);

    }



    function fireSlideChanged(previousSlide, currentSlide) {

      fireSlideEnter();



      // dispatch for shiny

      if (window.jQuery) {

        if (previousSlide) {

          window.jQuery(previousSlide).trigger("hidden");

        }

        if (currentSlide) {

          window.jQuery(currentSlide).trigger("shown");

        }

      }

    }



    // hookup for slidy

    if (window.w3c_slidy) {

      window.w3c_slidy.add_observer(function (slide_num) {

        // slide_num starts at position 1

        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);

      });

    }



  })();

</script>



<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/lmaowisc\.github\.io\/tidysurv\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>